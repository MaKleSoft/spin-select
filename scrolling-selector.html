<link rel="import" href="../polymer/polymer.html">
<script src="zynga-scroller/Animate.js"></script>
<script src="zynga-scroller/Scroller.js"></script>

<polymer-element name="scrolling-selector" touch-action="pan-y">

<template>

    <style>

        :host {
            display: block;
            position: relative;
            overflow: hidden;
            -webkit-user-select: none;
        }

        ::content > * {
            display: none;
        }

        #optionsWheel {
            -webkit-transform-style: preserve-3d;
            transform-style: preserve-3d;
            overflow: visible;
            position: relative;
            height: 100%;
        }

        #optionsWheel > * {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            margin: auto 0;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            text-align: center;
            height: 50px;
            line-height: 50px;
            cursor: pointer;
        }

        .overlay {
            pointer-events: none;
        }

        .slid {
            height: 35px;
            border-top: solid 1px;
            border-bottom: solid 1px;
        }

        .screen {
            background: rgba(255, 255, 255, 0.7);
        }

        .screen::after {
            content: '';
            display: block;
            position: absolute;
            width: 100%;
            height: 50px;
        }

        .screen.top::after {
            top: 0;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0));
        }

        .screen.bottom::after {
            bottom: 0;
            background: linear-gradient(to top, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0));
        }

    </style>

    <div id="optionsWheel"></div>

    <div fit layout vertical class="overlay">
        <div flex class="screen top"></div>
        <div class="slid"></div>
        <div flex class="screen bottom"></div>
    </div>
    <content></content>

</template>

<script>

(function() {
    'use strict';

    var stepSize = 40;
    var scrollBuffer = 1000 * stepSize;
    var perspective = 1000;

    Polymer({

        _faces: [],
        _faceInd: 0,
        _optInd: 0,

        publish: {
            options: [],
            faceCount: 20,
            faceHeight: 70,
            selected: 0
        },

        observe: {
            'faceCount faceHeight': 'renderWheel',
            'options': 'updateFaces'
        },

        attached: function() {
            this.setupScroller();
            this.renderWheel();
            this.setupEventListeners();
        },

        setupScroller: function() {
            var scroller = this.scroller = new Scroller(this.scroll.bind(this), {
                scrollingX: false,
                snapping: true,
                scrollingComplete: this.scrollingComplete.bind(this)
            });

            scroller.setDimensions(1, 1, 1, 2 * scrollBuffer);
            scroller.scrollTo(0, scrollBuffer);
            scroller.setSnapSize(0, stepSize);
        },

        setupEventListeners: function() {
            var scroller = this.scroller;
            var scrolling = false;

            if ('ontouchstart' in window) {
                this.addEventListener('touchstart', function(e) {
                    scroller.doTouchStart(e.touches, e.timeStamp);
                    scrolling = true;
                    e.preventDefault();
                }, false);
                document.addEventListener('touchmove', function(e) {
                    if (scrolling) {
                        scroller.doTouchMove(e.touches, e.timeStamp);
                    }
                }, false);
                document.addEventListener('touchend', function(e) {
                    if (scrolling) {
                        scroller.doTouchEnd(e.timeStamp);
                    }
                    scrolling = false;
                }, false);
            } else {
                this.addEventListener('mousedown', function(e) {
                    scroller.doTouchStart([e], e.timeStamp);
                    scrolling = true;
                }, false);
                document.addEventListener('mousemove', function(e) {
                    if (scrolling) {
                        scroller.doTouchMove([e], e.timeStamp);
                    }
                }, false);
                document.addEventListener('mouseup', function(e) {
                    if (scrolling) {
                        scroller.doTouchEnd(e.timeStamp);
                    }
                    scrolling = false;
                }, false);
            }

        },

        renderWheel: function() {
            var n = this.faceCount;
            var l = this.faceHeight;
            var a = this._a = 2 * Math.PI / n;
            var r = l / 2 / Math.tan(a);
            var wheel = this.$.optionsWheel;

            while (wheel.firstChild) {
                wheel.removeChild(wheel.firstChild);
            }

            this.style.perspective = this.webkitPerspective = perspective + 'px';
            this.style.height = 2 * r * perspective / (perspective + r) + 'px';
            wheel.style.transformOrigin = 'center center ' + (-r) + 'px';

            this._faces = [];
            var el;
            for (var i = 0; i < n ; i++) {
                el = document.createElement('div');
                el.style.transformOrigin = el.style.webkitTransformOrigin = 'center center ' + (-r) + 'px';
                el.style.transform = el.style.webkitTransform = 'rotateX(' + (-a * i) + 'rad)';
                PolymerGestures.addEventListener(el, 'tap', this.optionTapped.bind(this));
                wheel.appendChild(el);
                this._faces.push(el);
            }

            this.updateFaces();
        },

        scroll: function(x, y) {
            var i = (y - scrollBuffer) / stepSize;
            var a = this._a * i;
            var wheel = this.$.optionsWheel;
            var oCount = this.options.length;
            var fCount = this.faceCount;

            this._optInd = (oCount + Math.round(i % oCount)) % oCount;
            this._faceInd = (fCount + Math.round(i % fCount)) % fCount;

            this.updateFaces();

            wheel.style.transform = wheel.style.webkitTransform = 'rotateX(' + a + 'rad)';
        },

        updateFaces: function() {
            var faceCount = this._faces.length;
            var optCount = this.options.length;

            var el, i;
            for (var j = -Math.floor(faceCount/2), to = Math.ceil(faceCount/2); j < to; j++) {
                el = this._faces[(faceCount + this._faceInd + j) % faceCount];
                i = (optCount + this._optInd + j) % optCount;
                el.innerHTML = this.options[i];
                el.setAttribute('index', i);
            }
        },

        scrollingComplete: function() {
            if (this.selected != this._optInd) {
                this._ignoreSelectedChange = true;
            }
            this.selected = this._optInd;
        },

        selectedChanged: function(old) {
            if (!this._ignoreSelectedChange) {
                var i = Math.round((this.scroller.getValues().top - scrollBuffer) / stepSize);
                var l = this.options.length;
                var prev = i - i % l - l + this.selected;
                var next = i + (l - i % l) - l + this.selected;
                var scrollTop = (Math.abs(i - prev) < Math.abs(i - next) ? prev : next) * stepSize;
                scrollTop += scrollBuffer;
                this.scroller.scrollTo(0, scrollTop, true);
            }
            this._ignoreSelectedChange = false;
        },

        optionTapped: function(e) {
            console.log(e.target);
            this.selected = parseInt(e.target.getAttribute('index'), 10);
        }

    });

})();

</script>

</polymer-element>
